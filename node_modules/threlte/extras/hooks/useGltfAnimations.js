import { onDestroy } from 'svelte';
import { writable } from 'svelte/store';
import { AnimationMixer } from 'three';
import { useFrame } from '../../hooks/useFrame';
export function useGltfAnimations(gltfOrCallback, callback) {
    const gltf = gltfOrCallback && typeof gltfOrCallback !== 'function'
        ? gltfOrCallback
        : writable(undefined);
    const cb = gltfOrCallback && typeof gltfOrCallback === 'function' ? gltfOrCallback : callback;
    const mixerStore = writable(undefined);
    const actions = writable({});
    const unsubscribe = gltf.subscribe((gltf) => {
        if (!gltf || !gltf.scene || !gltf.animations.length)
            return;
        const newMixer = new AnimationMixer(gltf.scene);
        const newActions = gltf.animations.reduce((acc, clip) => {
            const action = newMixer.clipAction(clip, newMixer.getRoot());
            return {
                ...acc,
                [clip.name]: action
            };
        }, {});
        mixerStore.set(newMixer);
        actions.set(newActions);
        cb?.({
            actions: newActions,
            mixer: newMixer
        });
    });
    onDestroy(unsubscribe);
    let mixer = undefined;
    const unsubscribeMixer = mixerStore.subscribe((m) => (mixer = m));
    onDestroy(unsubscribeMixer);
    useFrame((_, delta) => {
        if (!mixer)
            return;
        mixer.update(delta);
    }, {
        debugFrameloopMessage: 'useGltfAnimations: AnimationMixer updated'
    });
    return {
        gltf,
        mixer: mixerStore,
        actions
    };
}
